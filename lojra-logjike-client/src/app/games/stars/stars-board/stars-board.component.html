<div class="stars-board-wrapper">
  <svg #boardSvg class="stars-board-svg"
       [attr.width]="svgWidth" [attr.height]="svgHeight"
       [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight"
       xmlns="http://www.w3.org/2000/svg"
       (mouseleave)="onDragEnd()"
       (mouseup)="onDragEnd()"
       (touchstart)="onTouchStart($event)"
       (touchmove)="onTouchMove($event)"
       (touchend)="onDragEnd()"
       (touchcancel)="onDragEnd()">

    <defs>
      <clipPath id="stars-board-clip">
        <rect x="0" y="0" [attr.width]="svgWidth" [attr.height]="svgHeight" rx="14" ry="14"/>
      </clipPath>
      <pattern id="stars-conflict-stripes" width="8" height="8"
               patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
        <rect width="4" height="8" fill="rgba(220, 38, 38, 0.35)"/>
      </pattern>
    </defs>

    <g clip-path="url(#stars-board-clip)">

      <!-- Zone backgrounds -->
      @for (i of cells; track i) {
        <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
              [attr.width]="cellSize" [attr.height]="cellSize"
              [attr.fill]="zoneColor(i)"/>
      }

      <!-- Thin grid lines -->
      @for (line of horizontalGridLines; track $index) {
        <line x1="0" [attr.y1]="line.y" [attr.x2]="svgWidth" [attr.y2]="line.y"
              stroke="rgba(0,0,0,0.07)" stroke-width="1"/>
      }
      @for (line of verticalGridLines; track $index) {
        <line [attr.x1]="line.x" y1="0" [attr.x2]="line.x" [attr.y2]="svgHeight"
              stroke="rgba(0,0,0,0.07)" stroke-width="1"/>
      }

      <!-- Zone borders -->
      @for (border of zoneBorders; track $index) {
        <line [attr.x1]="border.x1" [attr.y1]="border.y1"
              [attr.x2]="border.x2" [attr.y2]="border.y2"
              stroke="#1a1a1a" stroke-width="3" stroke-linecap="round"/>
      }

      <!-- X marks -->
      @for (i of cells; track i) {
        @if (isMarkX(i)) {
          <g class="mark-x"
             [attr.transform]="'translate(' + (cellX(i) + cellSize/2) + ',' + (cellY(i) + cellSize/2) + ')'">
            <line [attr.x1]="-xSize/2" [attr.y1]="-xSize/2" [attr.x2]="xSize/2" [attr.y2]="xSize/2"
                  stroke="#888" stroke-width="1.5" stroke-linecap="round"/>
            <line [attr.x1]="xSize/2" [attr.y1]="-xSize/2" [attr.x2]="-xSize/2" [attr.y2]="xSize/2"
                  stroke="#888" stroke-width="1.5" stroke-linecap="round"/>
          </g>
        }
      }

      <!-- Star icons -->
      @for (i of cells; track i) {
        @if (isStar(i)) {
          <!-- Outer g: positioning only -->
          <g [attr.transform]="'translate(' + starX(i) + ',' + starY(i) + ')'">
            <!-- Inner g: animation target -->
            <g class="star-icon"
               [class.star-win]="game.gameWon()"
               [style.animation-delay]="game.gameWon() ? (starWinDelay(i) + 'ms') : '0ms'">
              <g [attr.transform]="'scale(' + (starSize / 24) + ') translate(-12, -12)'">
                <polygon
                  points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  fill="#F59E0B" stroke="#1a1a1a" stroke-width="2.5" stroke-linejoin="round"
                  paint-order="stroke fill"/>
              </g>
            </g>
          </g>
        }
      }

      <!-- Conflict overlay -->
      @for (i of cells; track i) {
        @if (isConflict(i)) {
          <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
                [attr.width]="cellSize" [attr.height]="cellSize"
                fill="rgba(220, 38, 38, 0.12)" class="conflict-cell"/>
          <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
                [attr.width]="cellSize" [attr.height]="cellSize"
                fill="url(#stars-conflict-stripes)" class="conflict-cell"/>
        }
      }

      <!-- Hint highlight -->
      @for (i of cells; track i) {
        @if (isHintCell(i)) {
          <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
                [attr.width]="cellSize" [attr.height]="cellSize"
                class="hint-cell" rx="4" ry="4"/>
        }
      }

      <!-- Invisible interaction layer -->
      @for (i of cells; track i) {
        <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
              [attr.width]="cellSize" [attr.height]="cellSize"
              class="interaction-cell"
              [class.has-star]="isStar(i)"
              (click)="onCellClick(i)"
              (mousedown)="onDragStart(i, $event)"
              (mouseenter)="onDragOver(i)"/>
      }
    </g>

    <!-- Outer border -->
    <rect x="1.5" y="1.5"
          [attr.width]="svgWidth - 3" [attr.height]="svgHeight - 3"
          rx="14" ry="14" fill="none" stroke="#1a1a1a" stroke-width="3"/>
  </svg>
</div>
