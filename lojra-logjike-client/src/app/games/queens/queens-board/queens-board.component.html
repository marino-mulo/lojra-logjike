<div class="queens-board-wrapper">
  <svg class="queens-board-svg"
       [attr.width]="svgWidth" [attr.height]="svgHeight"
       [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight"
       xmlns="http://www.w3.org/2000/svg"
       (mouseleave)="onDragEnd()"
       (mouseup)="onDragEnd()"
       (touchstart)="onTouchStart($event)"
       (touchmove)="onTouchMove($event)"
       (touchend)="onDragEnd()"
       (touchcancel)="onDragEnd()">

    <defs>
      <clipPath id="queens-board-clip">
        <rect x="0" y="0"
              [attr.width]="svgWidth" [attr.height]="svgHeight"
              rx="14" ry="14"/>
      </clipPath>
      <!-- Diagonal stripe pattern for conflicting queens -->
      <pattern id="conflict-stripes" width="8" height="8"
               patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
        <rect width="4" height="8" fill="rgba(220, 38, 38, 0.35)"/>
      </pattern>
    </defs>

    <!-- Clipped content group -->
    <g clip-path="url(#queens-board-clip)">

      <!-- Zone-colored cell backgrounds -->
      @for (i of cells; track i) {
        <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
              [attr.width]="cellSize" [attr.height]="cellSize"
              [attr.fill]="zoneColor(i)"/>
      }

      <!-- Thin internal grid lines -->
      @for (line of horizontalGridLines; track $index) {
        <line x1="0" [attr.y1]="line.y"
              [attr.x2]="svgWidth" [attr.y2]="line.y"
              stroke="rgba(0,0,0,0.08)" stroke-width="1"/>
      }
      @for (line of verticalGridLines; track $index) {
        <line [attr.x1]="line.x" y1="0"
              [attr.x2]="line.x" [attr.y2]="svgHeight"
              stroke="rgba(0,0,0,0.08)" stroke-width="1"/>
      }

      <!-- Thick zone borders -->
      @for (border of zoneBorders; track $index) {
        <line [attr.x1]="border.x1" [attr.y1]="border.y1"
              [attr.x2]="border.x2" [attr.y2]="border.y2"
              stroke="#1a1a1a" stroke-width="3" stroke-linecap="round"/>
      }

      <!-- X marks (dark small Ã— lines) -->
      @for (i of cells; track i) {
        @if (isMarkX(i)) {
          <g class="mark-x" [attr.transform]="'translate(' + (cellX(i) + cellSize / 2) + ',' + (cellY(i) + cellSize / 2) + ')'">
            <line [attr.x1]="-xSize / 2" [attr.y1]="-xSize / 2"
                  [attr.x2]="xSize / 2" [attr.y2]="xSize / 2"
                  stroke="#666" stroke-width="1.5" stroke-linecap="round"/>
            <line [attr.x1]="xSize / 2" [attr.y1]="-xSize / 2"
                  [attr.x2]="-xSize / 2" [attr.y2]="xSize / 2"
                  stroke="#666" stroke-width="1.5" stroke-linecap="round"/>
          </g>
        }
      }

      <!-- Queen crowns (coral) -->
      @for (i of cells; track i) {
        @if (isQueen(i)) {
          <g class="queen-icon"
             [class.queen-win]="game.gameWon()"
             [attr.transform]="'translate(' + queenX(i) + ',' + queenY(i) + ')'">
            <!-- Crown shape -->
            <g [attr.transform]="'scale(' + (queenSize / 24) + ') translate(-12, -12)'">
              <!-- Crown base -->
              <rect x="5" y="19" width="14" height="3" rx="1"
                    fill="#E11D48" stroke="#1a1a1a" stroke-width="1"/>
              <!-- Crown body -->
              <path d="M6,19 L4,8 L9,13 L12,5 L15,13 L20,8 L18,19 Z"
                    fill="#FB7185" stroke="#1a1a1a" stroke-width="1"
                    stroke-linejoin="round"/>
              <!-- Crown jewels -->
              <circle cx="4" cy="7" r="1.8" fill="#E11D48" stroke="#1a1a1a" stroke-width="0.8"/>
              <circle cx="12" cy="4" r="1.8" fill="#E11D48" stroke="#1a1a1a" stroke-width="0.8"/>
              <circle cx="20" cy="7" r="1.8" fill="#E11D48" stroke="#1a1a1a" stroke-width="0.8"/>
            </g>
          </g>
        }
      }

      <!-- Conflict overlay: red diagonal stripes on conflicting queens -->
      @for (i of cells; track i) {
        @if (isConflict(i)) {
          <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
                [attr.width]="cellSize" [attr.height]="cellSize"
                fill="rgba(220, 38, 38, 0.12)"
                class="conflict-cell"/>
          <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
                [attr.width]="cellSize" [attr.height]="cellSize"
                fill="url(#conflict-stripes)"
                class="conflict-cell"/>
        }
      }

      <!-- Hint cell highlight overlay -->
      @for (i of cells; track i) {
        @if (isHintCell(i)) {
          <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
                [attr.width]="cellSize" [attr.height]="cellSize"
                class="hint-cell" rx="4" ry="4"/>
        }
      }

      <!-- Invisible interaction cells (topmost for click/drag events) -->
      @for (i of cells; track i) {
        <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
              [attr.width]="cellSize" [attr.height]="cellSize"
              class="interaction-cell"
              [class.has-queen]="isQueen(i)"
              (click)="onCellClick(i)"
              (mousedown)="onDragStart(i, $event)"
              (mouseenter)="onDragOver(i)"/>
      }
    </g>

    <!-- Outer border (drawn on top, outside clip) -->
    <rect x="1.5" y="1.5"
          [attr.width]="svgWidth - 3" [attr.height]="svgHeight - 3"
          rx="14" ry="14"
          fill="none" stroke="#1a1a1a" stroke-width="3"/>
  </svg>
</div>
