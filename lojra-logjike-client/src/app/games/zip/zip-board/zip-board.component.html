<div class="zip-board-wrapper" (touchmove)="onTouchMove($event)">
  <svg class="zip-board-svg"
       [attr.width]="svgWidth" [attr.height]="svgHeight"
       [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight"
       xmlns="http://www.w3.org/2000/svg">

    <defs>
      <clipPath id="board-clip">
        <rect x="0" y="0"
              [attr.width]="svgWidth" [attr.height]="svgHeight"
              [attr.rx]="borderRadius" [attr.ry]="borderRadius"/>
      </clipPath>
    </defs>

    <!-- Clipped content group -->
    <g clip-path="url(#board-clip)">

      <!-- Background fill -->
      <rect x="0" y="0"
            [attr.width]="svgWidth" [attr.height]="svgHeight"
            fill="white"/>

      <!-- Internal grid lines (thin, light) -->
      @for (line of horizontalGridLines; track $index) {
        <line [attr.x1]="line.x1" [attr.y1]="line.y1"
              [attr.x2]="line.x2" [attr.y2]="line.y2"
              stroke="#E8E4F0" stroke-width="1"/>
      }
      @for (line of verticalGridLines; track $index) {
        <line [attr.x1]="line.x1" [attr.y1]="line.y1"
              [attr.x2]="line.x2" [attr.y2]="line.y2"
              stroke="#E8E4F0" stroke-width="1"/>
      }

      <!-- Tube: individual segment lines with gradient coloring -->
      @for (seg of tubeSegmentLines; track seg.index) {
        <line [attr.x1]="seg.x1" [attr.y1]="seg.y1"
              [attr.x2]="seg.x2" [attr.y2]="seg.y2"
              [attr.stroke]="seg.color"
              [attr.stroke-width]="tubeWidth"
              stroke-linecap="round"
              class="tube-segment"
              [class.tube-win]="game.gameWon()"/>
      }

      <!-- Tube start cap (rounded circle at first cell) -->
      @if (startPosition; as start) {
        <circle [attr.cx]="start.cx" [attr.cy]="start.cy"
                [attr.r]="tubeWidth / 2"
                fill="rgb(168, 85, 247)"
                class="tube-segment"
                [class.tube-win]="game.gameWon()"/>
      }

      <!-- Tube head cap (slightly brighter circle at last cell) -->
      @if (headPosition; as head) {
        <circle [attr.cx]="head.cx" [attr.cy]="head.cy"
                [attr.r]="tubeWidth / 2"
                fill="rgb(148, 75, 237)"
                class="tube-segment tube-head"
                [class.tube-win]="game.gameWon()"/>
      }

      <!-- Wall lines (thick dark lines between cells) -->
      @for (wall of wallLines; track $index) {
        <line [attr.x1]="wall.x1" [attr.y1]="wall.y1"
              [attr.x2]="wall.x2" [attr.y2]="wall.y2"
              stroke="#1a1a1a" stroke-width="3.5" stroke-linecap="round"/>
      }

      <!-- Checkpoint number circles -->
      @for (cp of checkpointOverlays; track cp.value) {
        <g class="checkpoint-overlay" [class.on-path]="cp.onPath">
          <circle [attr.cx]="cp.x" [attr.cy]="cp.y" [attr.r]="checkpointRadius"
                  class="checkpoint-bg"/>
          <text [attr.x]="cp.x" [attr.y]="cp.y"
                class="checkpoint-text"
                dominant-baseline="central" text-anchor="middle">
            {{ cp.value }}
          </text>
        </g>
      }

      <!-- Invisible interaction cells (topmost layer for mouse/touch events) -->
      @for (i of cells; track i) {
        <rect [attr.x]="cellX(i)" [attr.y]="cellY(i)"
              [attr.width]="cellSize" [attr.height]="cellSize"
              [attr.data-index]="i"
              class="interaction-cell"
              [class.on-path]="game.pathSet().has(i)"
              [class.next-target]="isNextTarget(i)"
              (mousedown)="onMouseDown($event, i)"
              (mouseenter)="onMouseEnter(i)"
              (touchstart)="onTouchStart($event, i)"/>
      }
    </g>

    <!-- Outer border (drawn on top, outside clip) -->
    <rect [attr.x]="borderWidth / 2" [attr.y]="borderWidth / 2"
          [attr.width]="svgWidth - borderWidth" [attr.height]="svgHeight - borderWidth"
          [attr.rx]="borderRadius" [attr.ry]="borderRadius"
          fill="none" stroke="#1a1a1a" [attr.stroke-width]="borderWidth"/>
  </svg>
</div>
